<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Estuarium Education Programs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f8f9fb;
      --bg-alt: #ffffff;
      --card-bg: #ffffff;
      --accent: #5b9bd5;
      --accent-soft: rgba(91, 155, 213, 0.12);
      --orange: #ff9147;
      --orange-soft: rgba(255, 145, 71, 0.12);
      --text-main: #4a5568;
      --text-muted: #8892a6;
      --border-subtle: #e2e8f0;
      --blue-light: #e8f1f5;
      --shadow-soft: 0 2px 12px rgba(0, 0, 0, 0.06);
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-pill: 999px;
      --transition-fast: 160ms ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: linear-gradient(135deg, #f8f9fb 0%, #e8f1f5 100%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 24px clamp(18px, 4vw, 40px) 8px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: linear-gradient(180deg, var(--accent), #a8d5e2);
      color: #fff;
      box-shadow: var(--shadow-soft);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      width: 32px;
      height: 32px;
      border-radius: 40%;
      background: radial-gradient(circle at 30% 20%, #fff 0%, var(--orange) 60%, var(--accent) 100%);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3),
        0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-text span:first-child {
      font-weight: 600;
      letter-spacing: 0.05em;
      font-size: 0.85rem;
      text-transform: uppercase;
      opacity: 0.95;
    }

    .brand-text span:last-child {
      font-size: 1.02rem;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.88rem;
      flex-wrap: wrap;
    }

    .pill {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 6px 11px;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      background: rgba(255, 255, 255, 0.15);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #47d16c;
      box-shadow: 0 0 8px rgba(71, 209, 108, 0.9);
    }

    main {
      padding: 8px clamp(18px, 4vw, 40px) 32px;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto 40px;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.3fr);
      gap: 24px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .programs-panel {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 18px 18px 20px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-subtle);
      position: relative;
      overflow: hidden;
    }

    .panel-inner {
      position: relative;
      z-index: 1;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 10px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .panel-title-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .panel-title {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: var(--text-main);
    }

    .panel-subtitle {
      font-size: 0.86rem;
      color: var(--text-muted);
    }

    .filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-select {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: var(--bg);
      color: var(--text-main);
      padding: 6px 24px 6px 11px;
      font-size: 0.82rem;
      appearance: none;
      outline: none;
      position: relative;
      cursor: pointer;
      font-weight: 600;
    }

    .filter-select:focus-visible {
      outline: 2px solid var(--orange);
      outline-offset: 1px;
    }

    .filter-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .filter-wrapper::after {
      content: "▾";
      position: absolute;
      right: 9px;
      font-size: 0.72rem;
      color: var(--text-muted);
      pointer-events: none;
    }

    .program-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .program-card {
      background: var(--bg-alt);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 13px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 7px;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast),
        border-color var(--transition-fast), background 160ms ease-out;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .program-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      border-color: var(--accent);
      background: var(--blue-light);
    }

    .program-card.active {
      border-color: var(--orange);
      box-shadow: 0 0 0 2px rgba(255, 145, 71, 0.2), 0 8px 20px rgba(0, 0, 0, 0.1);
      background: var(--orange-soft);
    }

    .badge-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 0.75rem;
    }

    .program-name {
      font-weight: 700;
      font-size: 0.93rem;
      color: var(--text-main);
    }

    .badge {
      padding: 3px 9px;
      border-radius: var(--radius-pill);
      font-size: 0.7rem;
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
      background: var(--bg);
      font-weight: 600;
    }

    .badge-standards {
      border-style: dashed;
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .meta-row span {
      padding: 2px 7px;
      border-radius: var(--radius-pill);
      background: var(--bg);
      border: 1px solid var(--border-subtle);
      font-weight: 600;
    }

    .description {
      font-size: 0.78rem;
      color: var(--text-muted);
      line-height: 1.4;
      margin-top: 2px;
    }

    .format-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    .format-pill {
      font-size: 0.7rem;
      border-radius: var(--radius-pill);
      padding: 2px 8px;
      background: var(--accent-soft);
      border: 1px solid rgba(91, 155, 213, 0.3);
      color: var(--accent);
      font-weight: 600;
    }

    .quick-cost {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .quick-cost strong {
      font-size: 0.9rem;
      color: var(--orange);
      font-weight: 700;
    }

    .details-panel {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 16px 16px 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    .details-inner {
      position: relative;
      z-index: 1;
    }

    .details-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .details-title-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .details-title {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--text-main);
    }

    .details-sub {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .tag {
      font-size: 0.72rem;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(91, 155, 213, 0.3);
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .section-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 4px;
      font-weight: 700;
    }

    .cost-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.2fr);
      gap: 10px;
    }

    @media (max-width: 600px) {
      .cost-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
    }

    label {
      font-size: 0.78rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    input[type="number"],
    select {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: var(--bg);
      color: var(--text-main);
      padding: 7px 9px;
      font-size: 0.8rem;
      outline: none;
      width: 100%;
      font-weight: 600;
    }

    input[type="number"]:focus-visible,
    select:focus-visible {
      border-color: var(--orange);
      box-shadow: 0 0 0 3px rgba(255, 145, 71, 0.15);
    }

    .cost-summary {
      background: linear-gradient(135deg, var(--orange-soft), var(--bg));
      border-radius: var(--radius-md);
      padding: 9px 10px;
      border: 1px solid rgba(255, 145, 71, 0.3);
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      font-size: 0.78rem;
    }

    .cost-item-label {
      color: var(--text-muted);
      font-weight: 600;
    }

    .cost-main {
      font-size: 1rem;
      font-weight: 700;
      color: var(--orange);
    }

    .cost-sub {
      font-size: 0.8rem;
      color: var(--accent);
      font-weight: 700;
    }

    .cost-footnote {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .form-panel {
      margin-top: 6px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: var(--bg);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-soft);
    }

    .form-panel-header {
      padding: 7px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      background: linear-gradient(90deg, var(--accent), #a8d5e2);
      color: #fff;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .form-panel-header span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .form-panel-header button {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      font-size: 0.72rem;
      padding: 4px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 600;
      transition: background 0.2s ease;
    }

    .form-panel-header button:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .form-panel iframe {
      border: none;
      width: 100%;
      height: 360px;
      background: #fff;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    .session-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin: 4px 0 2px;
    }

    .session-chip {
      font-size: 0.72rem;
      padding: 2px 7px;
      border-radius: var(--radius-pill);
      border: 1px dashed var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .session-chip strong {
      font-weight: 700;
    }

    .error-text {
      font-size: 0.7rem;
      color: #ff6b6b;
      margin-top: 2px;
      min-height: 1em;
      font-weight: 600;
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="brand">
      <div class="brand-mark"></div>
      <div class="brand-text">
        <span>Estuarium Education Project</span>
        <span>Teacher Program Selector</span>
      </div>
    </div>
    <div class="header-right">
      <div class="pill">
        <span class="pill-dot"></span>
        <span>Booking window now open</span>
      </div>
      <span>Choose a program, preview cost, and submit your inquiry in one place.</span>
    </div>
  </header>

  <main>
    <!-- LEFT: PROGRAM LIST -->
    <section class="programs-panel" aria-label="Program list">
      <div class="panel-inner">
        <div class="panel-header">
          <div class="panel-title-group">
            <div class="panel-title">Programs at a glance</div>
            <div class="panel-subtitle">Filter by grade band or pillar and click a card to see details.</div>
          </div>
          <div class="filters">
            <div class="filter-wrapper">
              <select id="gradeFilter" class="filter-select" aria-label="Filter by grade band">
                <option value="">All grade bands</option>
                <option value="PreK-2">PreK–2</option>
                <option value="3-5">Grades 3–5</option>
                <option value="6-8">Grades 6–8</option>
                <option value="8-10">Grades 8–10</option>
                <option value="9-12">Grades 9–12</option>
                <option value="10-12">Grades 10–12</option>
                <option value="Adult">Adult</option>
              </select>
            </div>
            <div class="filter-wrapper">
              <select id="pillarFilter" class="filter-select" aria-label="Filter by pillar">
                <option value="">All pillars</option>
                <option value="ELI">Estuarium Learning Initiative</option>
                <option value="EAN">Estuarium Action Network</option>
                <option value="ESI">Estuary Stewardship Initiative</option>
              </select>
            </div>
          </div>
        </div>

        <div id="programList" class="program-list" role="list">
          <!-- Cards injected by JS -->
        </div>
      </div>
    </section>

    <!-- RIGHT: DETAILS + COST + FORM -->
    <section class="details-panel" aria-label="Program detail and inquiry">
      <div class="details-inner">
        <div class="details-header">
          <div class="details-title-group">
            <div id="detailsTitle" class="details-title">Select a program to begin</div>
            <div id="detailsSub" class="details-sub">
              Quick description, standards, and session formats will appear here.
            </div>
          </div>
        </div>

        <div id="detailsTags" class="tag-row" aria-label="Program tags"></div>

        <div style="margin-top: 10px;">
          <div class="section-label">Program overview</div>
          <p id="detailsDescription" class="muted">
            Use the filters on the left to narrow by grade band or pillar, then click a program card to see details, adjust participant numbers, and preview pricing.
          </p>
          <div>
            <div class="session-chips" id="detailsSessions"></div>
          </div>
        </div>

        <div style="margin-top: 10px;">
          <div class="section-label">Estimate your program cost</div>
          <div class="cost-grid">
            <div>
              <div class="input-group">
                <label for="inputParticipants">Number of participants</label>
                <input type="number" id="inputParticipants" min="1" value="25" />
              </div>
              <div class="input-group">
                <label for="inputHours">Program length (hours)</label>
                <input type="number" id="inputHours" min="0.5" step="0.5" value="2" />
              </div>
              <div class="input-group">
                <label for="inputFormat">Session format</label>
                <select id="inputFormat">
                  <option value="field">1-day field trip</option>
                  <option value="multi">Multi-week series</option>
                  <option value="camp">5-day camp</option>
                  <option value="virtual">Virtual / on-campus</option>
                </select>
              </div>
              <div class="error-text" id="inputError"></div>
            </div>
            <div>
              <div class="cost-summary" aria-live="polite">
                <div>
                  <div class="cost-item-label">Estimated total</div>
                  <div id="totalCost" class="cost-main">$0.00</div>
                  <div class="cost-footnote">Includes instruction and coordination.</div>
                </div>
                <div>
                  <div class="cost-item-label">Per participant</div>
                  <div id="perParticipant" class="cost-sub">$0.00</div>
                  <div class="cost-footnote">
                    Calculated from the current group size.
                  </div>
                </div>
              </div>
            </div>
          </div>
          <p class="cost-footnote">
            This is a working estimate for planning purposes; final pricing will be confirmed after your inquiry.
          </p>
        </div>

        <div>
          <div class="section-label">Submit a program inquiry</div>
          <p class="muted">
            The form will prefill the program name you selected, so you can submit your request without leaving this page.
          </p>

          <div class="form-panel">
            <div class="form-panel-header">
              <span id="formProgramLabel">No program selected yet</span>
              <button type="button" onclick="openFormInNewTab()">
                Open in new tab
              </button>
            </div>
            <iframe
              id="inquiryFormFrame"
              title="Estuarium Program Inquiry"
              src="https://docs.google.com/forms/d/e/1FAIpQLSdHIjWiwmRy14Est89RnyVMbHxuHUyKDItmp3DNHAJXzRK1jQ/viewform?embedded=true">
            </iframe>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  const PROGRAMS = [
    {
      id: "sound-sprouts",
      name: "Sound Sprouts",
      gradeBand: "PreK-2",
      pillar: "ELI",
      standards: "Foundational NGSS, SEL early childhood",
      sessions: [
        "10-week: Around the Sound with Caregiver",
        "4-week: Bring the Outside In"
      ],
      formats: ["10-week", "4-week", "1-day field trip"],
      gradeLabel: "Infant–PreK with caregiver",
      shortDescription:
        "Playful, sensory-based estuary exploration for caregivers and young children, building curiosity and early science identity.",
    },
    {
      id: "little-sound-scouts",
      name: "Little Sound Scouts",
      gradeBand: "PreK-2",
      pillar: "ELI",
      standards: "NGSS K-ESS2-1, K-LS1-1; SEL",
      sessions: [
        "10-week: Seasons Around the Sound",
        "4-week: Small Scientists by the Shore",
        "5-day camp: My Estuary Adventure",
        "1-day: Little Beachcombers at the Shore"
      ],
      formats: ["10-week", "4-week", "5-day camp", "1-day field trip"],
      gradeLabel: "Grades K–2",
      shortDescription:
        "Early elementary nature adventures focusing on observation, wonder, and estuary exploration through hands-on play.",
    },
    {
      id: "sound-detectives",
      name: "Sound Detectives",
      gradeBand: "3-5",
      pillar: "ELI",
      standards: "NGSS 3-LS4-3, 4-ESS2-2, 5-PS1-3",
      sessions: [
        "10-week: Unlocking Estuary Mysteries",
        "4-week: Intro to Estuary Investigation",
        "5-day camp: Shifting Shoreline",
        "1-day: Junior Estuary Investigator"
      ],
      formats: ["10-week", "4-week", "5-day camp", "1-day field trip"],
      gradeLabel: "Grades 2–5 / 3–5 focus",
      shortDescription:
        "Inquiry-based field science where students collect data, map habitats, and solve estuary mysteries.",
    },
    {
      id: "eco-navigators",
      name: "Eco Navigators",
      gradeBand: "6-8",
      pillar: "ELI",
      standards: "Middle school NGSS (LS2.A, ESS3.C)",
      sessions: [
        "10-week: Unlocking Estuary Mysteries",
        "4-week: Four-Way Compass series",
        "5-day camp: Estuary Action Lab"
      ],
      formats: ["10-week", "4-week", "5-day camp", "1-day field trip"],
      gradeLabel: "Grades 6–8",
      shortDescription:
        "Middle school field program using navigation, mapping, and stewardship projects to explore estuary systems.",
    },
    {
      id: "echo-sounders",
      name: "Echo Sounders",
      gradeBand: "8-10",
      pillar: "ELI",
      standards: "MS-LS2-2, MS-LS2-5, MS-ESS3-3",
      sessions: [
        "10-week: Science for Belonging",
        "4-week: Field Science Foundations",
        "5-day camp: Echoes from the Shore",
        "1-day: Science Belongs to You"
      ],
      formats: ["10-week", "4-week", "5-day camp", "1-day intensive"],
      gradeLabel: "Grades 8–10",
      shortDescription:
        "Identity-centered field science that blends rigorous estuary research with belonging, leadership, and inclusion.",
    },
    {
      id: "sound-quest",
      name: "SoundQuest",
      gradeBand: "8-10",
      pillar: "ELI",
      standards: "MS-LS2-1, MS-LS2-5, MS-ESS3-3",
      sessions: [
        "10-week: Queer Ecology in Action",
        "4-week: Estuary, Identity, and Action",
        "5-day camp: Field Science for Queer Belonging",
        "1-day: Estuary Identity intensive"
      ],
      formats: ["10-week", "4-week", "5-day camp", "1-day intensive"],
      gradeLabel: "Grades 8–12 and LGBTQIA youth",
      shortDescription:
        "Queer-inclusive estuary program combining field science, arts, and identity-affirming leadership.",
    },
    {
      id: "sound-scholars",
      name: "Sound Scholars",
      gradeBand: "10-12",
      pillar: "ELI",
      standards: "HS-LS2-6, HS-ESS3-4, HS-ETS1-3",
      sessions: [
        "10-week: Leadership Through Estuary Science",
        "4-week: Youth Science in Action",
        "5-day camp: Science, Stewardship, and Story",
        "1-day: Lead Like a Scientist"
      ],
      formats: ["10-week", "4-week", "5-day camp", "1-day intensive"],
      gradeLabel: "Grades 10–12",
      shortDescription:
        "Advanced high school field research, science communication, and youth leadership in estuary science.",
    },
    {
      id: "sound-trekkers",
      name: "Sound Trekkers",
      gradeBand: "Adult",
      pillar: "EAN",
      standards: "Adult NGSS-aligned field science",
      sessions: [
        "10-week: Knowing the Sound, Caring for the Sound",
        "4-week: Estuary Essentials",
        "5-day: Field Science for Everyday People",
        "1-day: Walk the Estuary, Know the Sound"
      ],
      formats: ["10-week", "4-week", "5-day mini course", "1-day intensive"],
      gradeLabel: "Adults 18+",
      shortDescription:
        "Immersive adult field program for aspiring naturalists and community stewards.",
    },
    {
      id: "our-sound-selves",
      name: "Our Sound Selves",
      gradeBand: "Adult",
      pillar: "EAN",
      standards: "NGSS crosscutting concepts; SEL for adults",
      sessions: [
        "10-week: The Estuary Within",
        "4-week: Reflections in the Water",
        "5-day: Echoes of the Estuary",
        "1-day: The Sound Within"
      ],
      formats: ["10-week", "4-week", "5-day mini course", "1-day workshop"],
      gradeLabel: "Adults 18+",
      shortDescription:
        "Reflective estuary program connecting ecological literacy with emotional wellbeing and story.",
    },
  ];

  const COST_CONFIG = {
    baseCoordinationFee: 50,
    hourlyRatePerInstructor: 25,
    markupMultiplier: 1.8,
    formats: {
      field: 1.0,
      multi: 1.15,
      camp: 1.25,
      virtual: 0.9,
    },
    ratios: {
      "PreK-2": 6,
      "3-5": 8,
      "6-8": 10,
      "8-10": 10,
      "9-12": 12,
      "10-12": 12,
      Adult: 15,
      default: 12,
    },
  };

  const programListEl = document.getElementById("programList");
  const gradeFilterEl = document.getElementById("gradeFilter");
  const pillarFilterEl = document.getElementById("pillarFilter");

  const detailsTitleEl = document.getElementById("detailsTitle");
  const detailsSubEl = document.getElementById("detailsSub");
  const detailsTagsEl = document.getElementById("detailsTags");
  const detailsDescriptionEl = document.getElementById("detailsDescription");
  const detailsSessionsEl = document.getElementById("detailsSessions");

  const inputParticipantsEl = document.getElementById("inputParticipants");
  const inputHoursEl = document.getElementById("inputHours");
  const inputFormatEl = document.getElementById("inputFormat");
  const inputErrorEl = document.getElementById("inputError");

  const totalCostEl = document.getElementById("totalCost");
  const perParticipantEl = document.getElementById("perParticipant");

  const formProgramLabelEl = document.getElementById("formProgramLabel");
  const formFrameEl = document.getElementById("inquiryFormFrame");

  let activeProgramId = null;

  function getRatioForProgram(program) {
    return (
      COST_CONFIG.ratios[program.gradeBand] ?? COST_CONFIG.ratios.default
    );
  }

  function calculateCost(program, participants, hours, formatKey) {
    const ratio = getRatioForProgram(program);
    const instructorsNeeded =
      participants > 0 ? Math.ceil(participants / ratio) : 0;

    const staffCost = instructorsNeeded * COST_CONFIG.hourlyRatePerInstructor * hours;
    const coordinationFee = COST_CONFIG.baseCoordinationFee;

    const formatMultiplier =
      COST_CONFIG.formats[formatKey] ?? COST_CONFIG.formats.field;

    const subtotal = staffCost + coordinationFee;
    const totalProgramCost = subtotal * COST_CONFIG.markupMultiplier * formatMultiplier;

    const pricePerParticipant =
      participants > 0 ? totalProgramCost / participants : 0;

    return {
      instructorsNeeded,
      totalProgramCost,
      pricePerParticipant,
    };
  }

  function renderPrograms() {
    const gradeFilter = gradeFilterEl.value;
    const pillarFilter = pillarFilterEl.value;

    programListEl.innerHTML = "";

    PROGRAMS.forEach((program) => {
      if (gradeFilter && program.gradeBand !== gradeFilter) return;
      if (pillarFilter && program.pillar !== pillarFilter) return;

      const card = document.createElement("button");
      card.type = "button";
      card.className = "program-card";
      card.setAttribute("data-id", program.id);
      card.setAttribute("role", "listitem");

      if (activeProgramId === program.id) {
        card.classList.add("active");
      }

      const quickEstimate = calculateCost(program, 25, 2, "field");

      card.innerHTML = `
        <div class="badge-row">
          <div class="program-name">${program.name}</div>
          <span class="badge badge-standards">${program.standards}</span>
        </div>
        <div class="meta-row">
          <span>${program.gradeLabel}</span>
          <span>Pillar: ${program.pillar}</span>
        </div>
        <p class="description">${program.shortDescription}</p>
        <div class="format-row">
          ${program.formats
            .map(
              (f) =>
                `<span class="format-pill">${f}</span>`
            )
            .join("")}
        </div>
        <div class="quick-cost">
          <span>Example: 25 students · 2 hr</span>
          <span>from <strong>${quickEstimate.totalProgramCost.toFixed(
            0
          )}</strong></span>
        </div>
      `;

      card.addEventListener("click", () => setActiveProgram(program.id));
      programListEl.appendChild(card);
    });

    if (!activeProgramId && PROGRAMS.length > 0) {
      const firstVisible = programListEl.querySelector(".program-card");
      if (firstVisible) {
        const id = firstVisible.getAttribute("data-id");
        setActiveProgram(id);
      }
    }
  }

  function setActiveProgram(programId) {
    const program = PROGRAMS.find((p) => p.id === programId);
    if (!program) return;
    activeProgramId = programId;

    Array.from(programListEl.children).forEach((card) => {
      card.classList.toggle(
        "active",
        card.getAttribute("data-id") === programId
      );
    });

    detailsTitleEl.textContent = program.name;
    detailsSubEl.textContent = `${program.gradeLabel} · Pillar ${program.pillar}`;
    detailsDescriptionEl.textContent = program.shortDescription;

    detailsTagsEl.innerHTML = "";
    const gradeTag = document.createElement("span");
    gradeTag.className = "tag";
    gradeTag.textContent = `Grade band: ${program.gradeBand}`;
    detailsTagsEl.appendChild(gradeTag);

    const standardTag = document.createElement("span");
    standardTag.className = "tag";
    standardTag.textContent = program.standards;
    detailsTagsEl.appendChild(standardTag);

    detailsSessionsEl.innerHTML = "";
    program.sessions.forEach((session) => {
      const chip = document.createElement("span");
      chip.className = "session-chip";
      chip.innerHTML = `<strong>Session:</strong> ${session}`;
      detailsSessionsEl.appendChild(chip);
    });

    formProgramLabelEl.textContent = `Inquiry form for: ${program.name}`;
    updateFormPrefill();
    recalcAndRender();
  }

  function recalcAndRender() {
    const participants = Number(inputParticipantsEl.value);
    const hours = Number(inputHoursEl.value);
    const formatKey = inputFormatEl.value;
    inputErrorEl.textContent = "";

    if (!activeProgramId) {
      totalCostEl.textContent = "$0.00";
      perParticipantEl.textContent = "$0.00";
      return;
    }

    if (!participants || participants <= 0 || !hours || hours <= 0) {
      inputErrorEl.textContent = "Enter a positive number of participants and hours.";
      totalCostEl.textContent = "$0.00";
      perParticipantEl.textContent = "$0.00";
      return;
    }

    const program = PROGRAMS.find((p) => p.id === activeProgramId);
    const { totalProgramCost, pricePerParticipant } = calculateCost(
      program,
      participants,
      hours,
      formatKey
    );

    totalCostEl.textContent = `${totalProgramCost.toFixed(2)}`;
    perParticipantEl.textContent = `${pricePerParticipant.toFixed(2)}`;
  }

  function updateFormPrefill() {
    const baseUrl =
      "https://docs.google.com/forms/d/e/1FAIpQLSdHIjWiwmRy14Est89RnyVMbHxuHUyKDItmp3DNHAJXzRK1jQ/viewform";

    const program = PROGRAMS.find((p) => p.id === activeProgramId);
    if (!program) {
      formFrameEl.src = baseUrl + "?embedded=true";
      return;
    }

    const encodedProgram = encodeURIComponent(program.name);
    const prefill = `?embedded=true&entry.123456789=${encodedProgram}`;
    formFrameEl.src = baseUrl + prefill;
  }

  function openFormInNewTab() {
    const baseUrl =
      "https://docs.google.com/forms/d/e/1FAIpQLSdHIjWiwmRy14Est89RnyVMbHxuHUyKDItmp3DNHAJXzRK1jQ/viewform";

    const program = PROGRAMS.find((p) => p.id === activeProgramId);
    if (!program) {
      window.open(baseUrl, "_blank");
      return;
    }

    const encodedProgram = encodeURIComponent(program.name);
    const prefill = `?entry.123456789=${encodedProgram}`;
    window.open(baseUrl + prefill, "_blank");
  }

  window.openFormInNewTab = openFormInNewTab;

  inputParticipantsEl.addEventListener("input", recalcAndRender);
  inputHoursEl.addEventListener("input", recalcAndRender);
  inputFormatEl.addEventListener("change", recalcAndRender);
  gradeFilterEl.addEventListener("change", renderPrograms);
  pillarFilterEl.addEventListener("change", renderPrograms);

  renderPrograms();